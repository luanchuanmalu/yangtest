<!DOCTYPE html>
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN"><!--<![endif]--><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>Kubernetes代码走读之Minion Node 组件 kube-proxy | Software Engineering Lab | Zhejiang University</title>
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="http://www.sel.zju.edu.cn/xmlrpc.php">
<!--[if lt IE 9]>
<script src="http://www.sel.zju.edu.cn/wp-content/themes/Wallpapered/js/html5.js" type="text/javascript"></script>
<![endif]-->
<link rel="alternate" type="application/rss+xml" title="Software Engineering Lab | Zhejiang University » Feed" href="http://www.sel.zju.edu.cn/?feed=rss2">
<link rel="alternate" type="application/rss+xml" title="Software Engineering Lab | Zhejiang University » 评论Feed" href="http://www.sel.zju.edu.cn/?feed=comments-rss2">
<link rel="alternate" type="application/rss+xml" title="Software Engineering Lab | Zhejiang University » Kubernetes代码走读之Minion Node 组件 kube-proxy评论Feed" href="http://www.sel.zju.edu.cn/?feed=rss2&amp;p=484">
<link rel="stylesheet" id="yarppWidgetCss-css" href="index_files/widget.css" type="text/css" media="all">
<link rel="stylesheet" id="crayon-css" href="index_files/crayon.css" type="text/css" media="all">
<link rel="stylesheet" id="crayon-theme-classic-css" href="index_files/classic.css" type="text/css" media="all">
<link rel="stylesheet" id="crayon-font-monaco-css" href="index_files/monaco.css" type="text/css" media="all">
<link rel="stylesheet" id="sgwp-style-css" href="index_files/style.css" type="text/css" media="all">
<script src="index_files/analytics.js" async=""></script><script type="text/javascript" src="index_files/jquery.js"></script>
<script type="text/javascript" src="index_files/jquery-migrate.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"2.6.9","is_admin":"0","ajaxurl":"http:\/\/www.sel.zju.edu.cn\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"\u4f7f\u7528 %s \u590d\u5236\uff0c\u4f7f\u7528 %s \u7c98\u8d34\u3002","minimize":"\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801"};
/* ]]> */
</script>
<script type="text/javascript" src="index_files/crayon.js"></script>
<script type="text/javascript" src="index_files/comment-reply.js"></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.sel.zju.edu.cn/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.sel.zju.edu.cn/wp-includes/wlwmanifest.xml"> 
<link rel="prev" title="深入理解etcd技术分享PPT" href="http://www.sel.zju.edu.cn/?p=467">
<link rel="next" title="Docker源码分析（七）：Docker Container网络 （上）" href="http://www.sel.zju.edu.cn/?p=508">
<meta name="generator" content="WordPress 3.8.1">
<link rel="canonical" href="http://www.sel.zju.edu.cn/?p=484">
<link rel="shortlink" href="http://www.sel.zju.edu.cn/?p=484">

<!-- Protected by WP-SpamFree v2.1.1.2 :: JS BEGIN -->
<script type="text/javascript" src="index_files/wpsfv2-js.js"></script> 
<!-- Protected by WP-SpamFree v2.1.1.2 :: JS END -->

	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>

	<!-- Clean Archives Reloaded v3.2.0 | http://www.viper007bond.com/wordpress-plugins/clean-archives-reloaded/ -->
	<style type="text/css">.car-collapse .car-yearmonth { cursor: s-resize; } </style>
	<script type="text/javascript">
		/* <![CDATA[ */
			jQuery(document).ready(function() {
				jQuery('.car-collapse').find('.car-monthlisting').hide();
				jQuery('.car-collapse').find('.car-monthlisting:first').show();
				jQuery('.car-collapse').find('.car-yearmonth').click(function() {
					jQuery(this).next('ul').slideToggle('fast');
				});
				jQuery('.car-collapse').find('.car-toggler').click(function() {
					if ( '展开所有月份' == jQuery(this).text() ) {
						jQuery(this).parent('.car-container').find('.car-monthlisting').show();
						jQuery(this).text('折叠所有月份');
					}
					else {
						jQuery(this).parent('.car-container').find('.car-monthlisting').hide();
						jQuery(this).text('展开所有月份');
					}
					return false;
				});
			});
		/* ]]> */
	</script>

</head>

<body class="single single-post postid-484 single-format-standard singular">
<div id="page" class="hfeed">
	<header id="branding" class="clearfix" role="banner">
		<div class="main-nav">
			<nav id="access" class="wid960" role="navigation">
				<h3 class="assistive-text">Main menu</h3>
								<div class="skip-link"><a class="assistive-text" href="#content" title="">Skip to primary content</a></div>
				<div class="skip-link"><a class="assistive-text" href="#secondary" title="">Skip to secondary content</a></div>
								<div class="menu"><ul><li><a href="http://www.sel.zju.edu.cn/">首页</a></li><li class="page_item page-item-2"><a href="http://www.sel.zju.edu.cn/?page_id=2">关于SEL/VLIS实验室</a></li><li class="page_item page-item-30"><a href="http://www.sel.zju.edu.cn/?page_id=30">文章归档</a></li></ul></div>
										
<form method="get" id="searchform" action="http://www.sel.zju.edu.cn/">
	<label for="s" class="assistive-text">Search</label>
	<input class="field" name="s" id="s" placeholder="" type="text">
	<input class="submit" name="submit" id="searchsubmit" value="" type="submit">
</form>
							<div class="clr"></div>
			</nav>
		</div>
		<div class="wid960 slider">	
			<a class="standart-image" href="http://www.sel.zju.edu.cn/"><img src="index_files/standard-header.png" alt=""></a>
						<div class="title-wrap">
				<h1 id="site-title">
					<a href="http://www.sel.zju.edu.cn/" title="Software Engineering Lab | Zhejiang University" rel="home" class="aligncenter">Software Engineering Lab | Zhejiang University</a>
					<span id="site-description" class="aligncenter">浙江大学 | SEL实验室  | VLIS研究中心</span>
				</h1>
			</div>
		</div>
	</header>
	
	<div id="main" class="wid960 clearfix">


		<div id="primary">
			<div id="content" role="main">

				
					<nav id="nav-single">
						<h3 class="assistive-text">Post navigation</h3>
						<span class="nav-previous"><a href="http://www.sel.zju.edu.cn/?p=467" rel="prev"><span class="meta-nav">←</span> Previous</a></span>
						<span class="nav-next"><a href="http://www.sel.zju.edu.cn/?p=508" rel="next">Next <span class="meta-nav">→</span></a></span>
					</nav>

					<article id="post-484" class="post-484 post type-post status-publish format-standard hentry category-kubernetes tag-kubernetes">
	<header class="entry-header">
					<div class="comments-link">
				<a href="http://www.sel.zju.edu.cn/?p=484#comments" title="《Kubernetes代码走读之Minion Node 组件 kube-proxy》上的评论">1</a>			</div>
						<div class="entry-meta">
			<span class="sep">Posted on </span><a href="http://www.sel.zju.edu.cn/?p=484" title="下午2:16" rel="bookmark"><time class="entry-date" datetime="2015-01-22T14:16:32+00:00">2015年1月22日</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://www.sel.zju.edu.cn/?author=9" title="View all posts by chenxingyu" rel="author">chenxingyu</a></span></span>		</div>
				<h1 class="entry-title">Kubernetes代码走读之Minion Node 组件 kube-proxy</h1>
	</header>

	<div class="entry-content">
		<p>Kube-proxy是kubernetes 里运行在minion节点上的一个组件, 它起的作用是一个服务代理的角色. 
本文的内容将分为以下两部分, 源代码来自kubernetes release-0.8.1, 代码有删节，省略的代码或log输出用．．．表示:</p>
<p><em>1 Kube-proxy 简介</em></p>
<p><em>2 Kube-proxy代码解读</em></p>
<p><strong>1 Kube-proxy简介</strong></p>
<p>Kube-proxy网络代理运行在每个minion节点上。网上很多人所说这个proxy是kubernetes里的SDN组件，我本人并不这么
认为, 我认为可以把他看成是一个高级的反向代理．它的功能反映了定义在每个节点上Kubernetes 
API中的Services信息，并且可以做简单的TCP流转发或在一组服务后端做round robin的流转发．服务端点目前通过与docker 
link 兼容的环境变量指定的端口被发现, 这些端口由服务代理打开．目前，用户必须在代理上选择一个端口以暴露服务.</p>
<p><span id="more-484"></span></p>
<p><strong>2 Kube-proxy代码解读</strong></p>
<p>Kube-proxy代码入口定义在cmd/kube-proxy/proxy.go中, 源代码较长,分段解读如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63bc8535484153" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func main() {
        flag.Parse()
        util.InitLogs()
        defer util.FlushLogs()
    
        if err := util.ApplyOomScoreAdj(*oomScoreAdj); err != nil {
            glog.Info(err)
        }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63bc8535484153-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63bc8535484153-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63bc8535484153-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63bc8535484153-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63bc8535484153-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63bc8535484153-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63bc8535484153-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63bc8535484153-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63bc8535484153-1"><span class="crayon-e">func </span><span class="crayon-e">main</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63bc8535484153-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">flag</span><span class="crayon-sy">.</span><span class="crayon-e">Parse</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63bc8535484153-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">util</span><span class="crayon-sy">.</span><span class="crayon-e">InitLogs</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63bc8535484153-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">defer </span><span class="crayon-v">util</span><span class="crayon-sy">.</span><span class="crayon-e">FlushLogs</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63bc8535484153-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63bc8535484153-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">util</span><span class="crayon-sy">.</span><span class="crayon-e">ApplyOomScoreAdj</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">oomScoreAdj</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63bc8535484153-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">Info</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63bc8535484153-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0033 seconds] -->
<p></p>
<p>首先</p>
<p><strong>1. 使用flag pkg初始化命令行参数到相应的变量, 如etcd_servers选项</strong></p>
<p><strong>2. 初始化log</strong></p>
<p><strong>3. 应用oomScoreAdj参数到/proc/self/oom_score_adj文件</strong>.<br>
oom_score_adj 是-1000到1000的数值, 用来表征进程当发生OOM(out of memory)时系统对该进程的行为,值越低越不容易被杀死.默认值是-899.</p>
<p><strong>4. 使用下列两个函数新建两个重要的数据结构 <em>ServiceConfig</em> 和 <em>EndpointsConfig</em></strong></p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c0a812023244" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">serviceConfig := config.NewServiceConfig()
endpointsConfig := config.NewEndpointsConfig()</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c0a812023244-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c0a812023244-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c0a812023244-1"><span class="crayon-v">serviceConfig</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">NewServiceConfig</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c0a812023244-2"><span class="crayon-v">endpointsConfig</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">NewEndpointsConfig</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p></p>
<p>由于proxy和kubernetes Service概念关系很大, 强烈建议读者访问<a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/services.md">kubernetes Service</a>官方文档了解其基本概念. 先介绍ServiceConfig结构体和相关操作NewServiceConfig(), 源代码如下, 定义在pkg/proxy/config/config.go中</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c15150165759" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">type ServiceConfig struct {
        mux     *config.Mux
        bcaster *config.Broadcaster
        store   *serviceStore
}
func NewServiceConfig() *ServiceConfig {
    updates := make(chan struct{})
    store := &amp;serviceStore{updates: updates, services: make(map[string]map[string]api.Service)}
    mux := config.NewMux(store)
    bcaster := config.NewBroadcaster()
    go watchForUpdates(bcaster, store, updates)
    return &amp;ServiceConfig{mux, bcaster, store}
}
</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c15150165759-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c15150165759-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c15150165759-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c15150165759-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c15150165759-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c15150165759-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63c15150165759-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c15150165759-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63c15150165759-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c15150165759-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63c15150165759-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c15150165759-12">12</div><div class="crayon-num" data-line="crayon-55ed572e63c15150165759-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c15150165759-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c15150165759-1"><span class="crayon-e">type</span><span class="crayon-h"> </span><span class="crayon-e">ServiceConfig</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c15150165759-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e ">mux&nbsp;&nbsp;&nbsp;&nbsp; *</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">Mux</span></div><div class="crayon-line" id="crayon-55ed572e63c15150165759-3"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e ">bcaster *</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">Broadcaster</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c15150165759-4"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e ">store&nbsp;&nbsp; *</span><span class="crayon-i">serviceStore</span></div><div class="crayon-line" id="crayon-55ed572e63c15150165759-5"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c15150165759-6"><span class="crayon-e">func </span><span class="crayon-e">NewServiceConfig</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-e">ServiceConfig</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c15150165759-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">updates</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">make</span><span class="crayon-sy">(</span><span class="crayon-e">chan</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c15150165759-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">store</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-e">serviceStore</span><span class="crayon-sy">{</span><span class="crayon-v">updates</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">updates</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">services</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">make</span><span class="crayon-sy">(</span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-v">api</span><span class="crayon-sy">.</span><span class="crayon-v">Service</span><span class="crayon-sy">)</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63c15150165759-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">mux</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">NewMux</span><span class="crayon-sy">(</span><span class="crayon-v">store</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c15150165759-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">bcaster</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">NewBroadcaster</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c15150165759-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">go </span><span class="crayon-e">watchForUpdates</span><span class="crayon-sy">(</span><span class="crayon-v">bcaster</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">store</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">updates</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c15150165759-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-e">ServiceConfig</span><span class="crayon-sy">{</span><span class="crayon-v">mux</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">bcaster</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">store</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63c15150165759-13"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c15150165759-14">&nbsp;</div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0062 seconds] -->
<p></p>
<p>ServiceConfig结构体跟踪记录Service配置信息的变化,他接受通过channel传递的Sevice上”set”,
　”add”,　”remove”的操作,　并使用相应的handler函数处理这些变化. 
ServiceConfig通过组合的方式将config.Mux, config.Broadcaster和serviceStore类集成起来. 
并启动一个goroutine watchForUpdates(bcaster, store, updates), 
watchForUpdates()函数源代码如下：</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c20723383642" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func watchForUpdates(bcaster *config.Broadcaster, accessor config.Accessor, updates &lt;-chan struct{}) {
        for _ = range updates {
            bcaster.Notify(accessor.MergedState())
        }
    }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c20723383642-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c20723383642-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c20723383642-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c20723383642-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c20723383642-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c20723383642-1"><span class="crayon-e">func </span><span class="crayon-e">watchForUpdates</span><span class="crayon-sy">(</span><span class="crayon-e ">bcaster *</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">Broadcaster</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">accessor </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">Accessor</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">updates</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">-</span><span class="crayon-e">chan</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c20723383642-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-h"> </span><span class="crayon-e">updates</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c20723383642-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">bcaster</span><span class="crayon-sy">.</span><span class="crayon-e">Notify</span><span class="crayon-sy">(</span><span class="crayon-v">accessor</span><span class="crayon-sy">.</span><span class="crayon-e">MergedState</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c20723383642-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63c20723383642-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0028 seconds] -->
<p></p>
<p>他的作用是当updates 
channel有可用的信息时,　调用bcaster.Notify()函数以广播的方式将MergedState()处理后的serivces信息通知
到各个Listener. 其中MergeState实际调用的是(s *serviceStore) MergedState(); 
bcaster.Notify()函数源码如下,　它定义在pkg/util/config/config.go中</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c2a630685987" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">// 通知所有listener.
func (b *Broadcaster) Notify(instance interface{}) {
    b.listenerLock.RLock()
    listeners := b.listeners
    b.listenerLock.RUnlock()
    for _, listener := range listeners {
        listener.OnUpdate(instance)
    }
}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c2a630685987-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c2a630685987-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c2a630685987-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c2a630685987-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c2a630685987-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c2a630685987-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63c2a630685987-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c2a630685987-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63c2a630685987-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c2a630685987-1"><span class="crayon-c">// 通知所有listener.</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c2a630685987-2"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">b *</span><span class="crayon-v">Broadcaster</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">Notify</span><span class="crayon-sy">(</span><span class="crayon-e">instance</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c2a630685987-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">b</span><span class="crayon-sy">.</span><span class="crayon-v">listenerLock</span><span class="crayon-sy">.</span><span class="crayon-e">RLock</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c2a630685987-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">listeners</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-sy">.</span><span class="crayon-i">listeners</span></div><div class="crayon-line" id="crayon-55ed572e63c2a630685987-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">b</span><span class="crayon-sy">.</span><span class="crayon-v">listenerLock</span><span class="crayon-sy">.</span><span class="crayon-e">RUnlock</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c2a630685987-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">listener</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-h"> </span><span class="crayon-e">listeners</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c2a630685987-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">listener</span><span class="crayon-sy">.</span><span class="crayon-e">OnUpdate</span><span class="crayon-sy">(</span><span class="crayon-v">instance</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c2a630685987-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63c2a630685987-9"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0035 seconds] -->
<p></p>
<p>listener 相关的结构体源代码如下, 可以看出<em>golang interface</em>的飘逸灵活用法:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c34375418265" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">type Listener interface {
        // OnUpdate 在每次object 有变化时被调用.
        OnUpdate(instance interface{})
    }
    
    // ListenerFunc 是一个函数类型，他以下面的方式实现了OnUpdate()函数.
    type ListenerFunc func(instance interface{})
    
    func (f ListenerFunc) OnUpdate(instance interface{}) {
        f(instance)
    }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c34375418265-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c34375418265-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c34375418265-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c34375418265-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c34375418265-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c34375418265-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63c34375418265-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c34375418265-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63c34375418265-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c34375418265-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63c34375418265-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c34375418265-1"><span class="crayon-e">type</span><span class="crayon-h"> </span><span class="crayon-e">Listener</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c34375418265-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// OnUpdate 在每次object 有变化时被调用.</span></div><div class="crayon-line" id="crayon-55ed572e63c34375418265-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">OnUpdate</span><span class="crayon-sy">(</span><span class="crayon-e">instance</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c34375418265-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63c34375418265-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c34375418265-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// ListenerFunc 是一个函数类型，他以下面的方式实现了OnUpdate()函数.</span></div><div class="crayon-line" id="crayon-55ed572e63c34375418265-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">type</span><span class="crayon-h"> </span><span class="crayon-e">ListenerFunc</span><span class="crayon-h"> </span><span class="crayon-e">func</span><span class="crayon-sy">(</span><span class="crayon-e">instance</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c34375418265-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-55ed572e63c34375418265-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">ListenerFunc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">OnUpdate</span><span class="crayon-sy">(</span><span class="crayon-e">instance</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c34375418265-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">f</span><span class="crayon-sy">(</span><span class="crayon-v">instance</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c34375418265-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0034 seconds] -->
<p></p>
<p>NewServiceConfig函数最后返回这个新建的ServiceConfig结构体.</p>
<p>EndpointsConfig 结构体类似于ServiceConfig结构体, 
相关的操作也与Service极其相似,也是采用组合的方式将config.Mux, config.Broadcaster, 
endpointsStore组合起来, 并马上启动一个goroutine 
watchForUpdates(),调用的和之前的watchForUpdates相同. <strong>5. 新建loadBalancerRR和代理proxier</strong></p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c3e383312145" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">loadBalancer := proxy.NewLoadBalancerRR()
proxier := proxy.NewProxier(loadBalancer, net.IP(bindAddress), iptables.New(exec.New(), protocol))
if proxier == nil {
    glog.Fatalf("failed to create proxier, aborting")
}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c3e383312145-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c3e383312145-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c3e383312145-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c3e383312145-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c3e383312145-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c3e383312145-1"><span class="crayon-v">loadBalancer</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxy</span><span class="crayon-sy">.</span><span class="crayon-e">NewLoadBalancerRR</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c3e383312145-2"><span class="crayon-v">proxier</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxy</span><span class="crayon-sy">.</span><span class="crayon-e">NewProxier</span><span class="crayon-sy">(</span><span class="crayon-v">loadBalancer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-e">IP</span><span class="crayon-sy">(</span><span class="crayon-v">bindAddress</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-e">New</span><span class="crayon-sy">(</span><span class="crayon-v">exec</span><span class="crayon-sy">.</span><span class="crayon-e">New</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">protocol</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c3e383312145-3"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c3e383312145-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">Fatalf</span><span class="crayon-sy">(</span><span class="crayon-s">"failed to create proxier, aborting"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c3e383312145-5"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0031 seconds] -->
<p></p>
<p>5.1 先介绍loadBalancer,源代码定义在pkg/proxy/roundrobin.go中,如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c48803504679" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">// LoadBalancerRR is 是一个使用round robin方式的负载均衡器的实现.
    type LoadBalancerRR struct {
        lock          sync.RWMutex
        endpointsMap  map[string][]string　//记录每个service的后端endpoint映射
        rrIndex       map[string]int //记录每个service下一次round robin轮到的后端index
        serviceDtlMap map[string]serviceDetail　//保存服务的名字和细节的映射
    }
    // NewLoadBalancerRR 返回一个新的LoadBalancerRR结构体.
    func NewLoadBalancerRR() *LoadBalancerRR {
        return &amp;LoadBalancerRR{
            endpointsMap:  make(map[string][]string),
            rrIndex:       make(map[string]int),
            serviceDtlMap: make(map[string]serviceDetail),
        }
    }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c48803504679-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c48803504679-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c48803504679-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c48803504679-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c48803504679-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c48803504679-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63c48803504679-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c48803504679-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63c48803504679-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c48803504679-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63c48803504679-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c48803504679-12">12</div><div class="crayon-num" data-line="crayon-55ed572e63c48803504679-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c48803504679-14">14</div><div class="crayon-num" data-line="crayon-55ed572e63c48803504679-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c48803504679-1"><span class="crayon-c">// LoadBalancerRR is 是一个使用round robin方式的负载均衡器的实现.</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c48803504679-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">type</span><span class="crayon-h"> </span><span class="crayon-e">LoadBalancerRR</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c48803504679-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">lock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">sync</span><span class="crayon-sy">.</span><span class="crayon-e">RWMutex</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c48803504679-4"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">endpointsMap&nbsp;&nbsp;</span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">string</span>　<span class="crayon-c">//记录每个service的后端endpoint映射</span></div><div class="crayon-line" id="crayon-55ed572e63c48803504679-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">rrIndex&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-c">//记录每个service下一次round robin轮到的后端index</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c48803504679-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serviceDtlMap </span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-i">serviceDetail</span>　<span class="crayon-c">//保存服务的名字和细节的映射</span></div><div class="crayon-line" id="crayon-55ed572e63c48803504679-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c48803504679-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// NewLoadBalancerRR 返回一个新的LoadBalancerRR结构体.</span></div><div class="crayon-line" id="crayon-55ed572e63c48803504679-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">func </span><span class="crayon-e">NewLoadBalancerRR</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-e">LoadBalancerRR</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c48803504679-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-e">LoadBalancerRR</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c48803504679-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">endpointsMap</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">make</span><span class="crayon-sy">(</span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">string</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c48803504679-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">rrIndex</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">make</span><span class="crayon-sy">(</span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-t">int</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63c48803504679-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">serviceDtlMap</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">make</span><span class="crayon-sy">(</span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-v">serviceDetail</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c48803504679-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63c48803504679-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0056 seconds] -->
<p></p>
<p>5.2 proxier源代码定义在pkg/proxy/proxier中,　如下</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c53934069164" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">// Proxier 结构体实现了一个简单的tcp代理
type Proxier struct {
    loadBalancer LoadBalancer
    mu           sync.Mutex // 保护下面的serviceMap数据结构
    serviceMap   map[string]*serviceInfo
    listenIP     net.IP
    iptables     iptables.Interface
    hostIP       net.IP
}
// NewProxier 新建并返回一个Proxier结构体
func NewProxier(loadBalancer LoadBalancer, listenIP net.IP, iptables iptables.Interface) *Proxier {
    ．．．
    hostIP, err := chooseHostInterface()
    ．．．
    // 清楚旧的iptables rules.
    iptablesDeleteOld(iptables)
    // 初始化 iptables.
    if err := iptablesInit(iptables); err != nil {
        glog.Errorf("Failed to initialize iptables: %v", err)
        return nil
    }
    
    if err := iptablesFlush(iptables); err != nil {
        glog.Errorf("Failed to flush iptables: %v", err)
        return nil
    }
    return &amp;Proxier{
        loadBalancer: loadBalancer,
        serviceMap:   make(map[string]*serviceInfo),
        listenIP:     listenIP,
        iptables:     iptables,
        hostIP:       hostIP,
    }
}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-12">12</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-14">14</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-16">16</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-18">18</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-20">20</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-22">22</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-24">24</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-26">26</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-28">28</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-30">30</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-32">32</div><div class="crayon-num" data-line="crayon-55ed572e63c53934069164-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c53934069164-34">34</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c53934069164-1"><span class="crayon-c">// Proxier 结构体实现了一个简单的tcp代理</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-2"><span class="crayon-e">type</span><span class="crayon-h"> </span><span class="crayon-e">Proxier</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">loadBalancer </span><span class="crayon-e">LoadBalancer</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-4"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">mu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">sync</span><span class="crayon-sy">.</span><span class="crayon-v">Mutex</span><span class="crayon-h"> </span><span class="crayon-c">// 保护下面的serviceMap数据结构</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serviceMap&nbsp;&nbsp; </span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-e">serviceInfo</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-6"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">listenIP&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-e">IP</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-7"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">iptables&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-t">Interface</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">hostIP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-i">IP</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-9"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-10"><span class="crayon-c">// NewProxier 新建并返回一个Proxier结构体</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-11"><span class="crayon-e">func </span><span class="crayon-e">NewProxier</span><span class="crayon-sy">(</span><span class="crayon-e">loadBalancer </span><span class="crayon-v">LoadBalancer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">listenIP </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-v">IP</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">iptables </span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-t">Interface</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-e">Proxier</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line" id="crayon-55ed572e63c53934069164-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">hostIP</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">chooseHostInterface</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line" id="crayon-55ed572e63c53934069164-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 清楚旧的iptables rules.</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">iptablesDeleteOld</span><span class="crayon-sy">(</span><span class="crayon-v">iptables</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 初始化 iptables.</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">iptablesInit</span><span class="crayon-sy">(</span><span class="crayon-v">iptables</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">Errorf</span><span class="crayon-sy">(</span><span class="crayon-s">"Failed to initialize iptables: %v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-i">nil</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">iptablesFlush</span><span class="crayon-sy">(</span><span class="crayon-v">iptables</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">Errorf</span><span class="crayon-sy">(</span><span class="crayon-s">"Failed to flush iptables: %v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-i">nil</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-e">Proxier</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">loadBalancer</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">loadBalancer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">serviceMap</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">make</span><span class="crayon-sy">(</span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">serviceInfo</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">listenIP</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">listenIP</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">iptables</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">iptables</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">hostIP</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">hostIP</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63c53934069164-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c53934069164-34"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0103 seconds] -->
<p></p>
<p>如上面的代码注释所说NewProxier函数初始化主机上的iptables信息. proxier组成的元素主要包含刚刚创建的loadBalancer对象和一个iptables的执行器,他负责根据service的变化信息更新iptables设置.</p>
<p><strong>6. 将刚刚新建的proxier和loadBalancer分别向servicesConfig和endpointsConfig绑定</strong></p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c5e356570198" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">serviceConfig.RegisterHandler(proxier)
endpointsConfig.RegisterHandler(loadBalancer)</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c5e356570198-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c5e356570198-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c5e356570198-1"><span class="crayon-v">serviceConfig</span><span class="crayon-sy">.</span><span class="crayon-e">RegisterHandler</span><span class="crayon-sy">(</span><span class="crayon-v">proxier</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c5e356570198-2"><span class="crayon-v">endpointsConfig</span><span class="crayon-sy">.</span><span class="crayon-e">RegisterHandler</span><span class="crayon-sy">(</span><span class="crayon-v">loadBalancer</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<p></p>
<p>他的作用是当service或endpoint的配置信息发生变化时，就调用proxier或loadbalancer的相关函数．</p>
<p>下面先介绍serviceConfig.RegisterHandler(proxier),源代码如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c68789550725" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func (c *ServiceConfig) RegisterHandler(handler ServiceConfigHandler) {
    c.bcaster.Add(config.ListenerFunc(func(instance interface{}) {
        handler.OnUpdate(instance.([]api.Service))
    }))
}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c68789550725-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c68789550725-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c68789550725-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c68789550725-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c68789550725-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c68789550725-1"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">c *</span><span class="crayon-v">ServiceConfig</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">RegisterHandler</span><span class="crayon-sy">(</span><span class="crayon-e">handler </span><span class="crayon-v">ServiceConfigHandler</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c68789550725-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-v">bcaster</span><span class="crayon-sy">.</span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">ListenerFunc</span><span class="crayon-sy">(</span><span class="crayon-e">func</span><span class="crayon-sy">(</span><span class="crayon-e">instance</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c68789550725-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">handler</span><span class="crayon-sy">.</span><span class="crayon-e">OnUpdate</span><span class="crayon-sy">(</span><span class="crayon-v">instance</span><span class="crayon-sy">.</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-v">api</span><span class="crayon-sy">.</span><span class="crayon-v">Service</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c68789550725-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c68789550725-5"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0029 seconds] -->
<p></p>
<p>这个函数的功能是将proxier的OnUpdate函数注册添加到上文说的serviceConfig的bcaster的Listener[] 
slice里,当从channel收到新的可用信息,　实际调用的是下面的OnUpdate()函数即Proxier对象的OnUpdate(). 
这个函数很重要，由于代码段比较长,下面分段解释，他定义在pkg/proxy/proxier.go 中.</p>
<p>首先看一下传进参数services的值</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c72634870242" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func (proxier *Proxier) OnUpdate(services []api.Service) {
    glog.V(4).Infof("Received update notice: %+v", services)</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c72634870242-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c72634870242-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c72634870242-1"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">proxier *</span><span class="crayon-v">Proxier</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">OnUpdate</span><span class="crayon-sy">(</span><span class="crayon-i">services</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-v">api</span><span class="crayon-sy">.</span><span class="crayon-v">Service</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c72634870242-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">4</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Infof</span><span class="crayon-sy">(</span><span class="crayon-s">"Received update notice: %+v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">services</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->
<p></p>
<p>从后端的一台minion机器上的kube-proxy.log查看一下传进来的services信息如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c7c361713246" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">I0112 09:48:02.876275   23642 proxier.go:443] Received update notice: [．．． ObjectMeta:{Name:redis-master ．．． 
Spec:{Port:6379 Protocol:TCP Selector:map[name:redis-master] PortalIP:11.1.1.83 ProxyPort:0 CreateExternalLoadBalancer:false 
PublicIPs:[] ContainerPort:{Kind:0 IntVal:6379 StrVal:} SessionAffinity:}]</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c7c361713246-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c7c361713246-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c7c361713246-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c7c361713246-1"><span class="crayon-i">I0112</span><span class="crayon-h"> </span><span class="crayon-cn">09</span><span class="crayon-o">:</span><span class="crayon-cn">48</span><span class="crayon-o">:</span><span class="crayon-cn">02.876275</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">23642</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-v">go</span><span class="crayon-o">:</span><span class="crayon-cn">443</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">Received </span><span class="crayon-e">update </span><span class="crayon-v">notice</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span>．．．<span class="crayon-h"> </span><span class="crayon-v">ObjectMeta</span><span class="crayon-o">:</span><span class="crayon-sy">{</span><span class="crayon-v">Name</span><span class="crayon-o">:</span><span class="crayon-v">redis</span><span class="crayon-o">-</span><span class="crayon-i">master</span><span class="crayon-h"> </span>．．．<span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c7c361713246-2"><span class="crayon-v">Spec</span><span class="crayon-o">:</span><span class="crayon-sy">{</span><span class="crayon-v">Port</span><span class="crayon-o">:</span><span class="crayon-cn">6379</span><span class="crayon-h"> </span><span class="crayon-v">Protocol</span><span class="crayon-o">:</span><span class="crayon-e">TCP </span><span class="crayon-v">Selector</span><span class="crayon-o">:</span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-v">name</span><span class="crayon-o">:</span><span class="crayon-v">redis</span><span class="crayon-o">-</span><span class="crayon-v">master</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">PortalIP</span><span class="crayon-o">:</span><span class="crayon-cn">11.1.1.83</span><span class="crayon-h"> </span><span class="crayon-v">ProxyPort</span><span class="crayon-o">:</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-v">CreateExternalLoadBalancer</span><span class="crayon-o">:</span><span class="crayon-t">false</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-55ed572e63c7c361713246-3"><span class="crayon-v">PublicIPs</span><span class="crayon-o">:</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">ContainerPort</span><span class="crayon-o">:</span><span class="crayon-sy">{</span><span class="crayon-v">Kind</span><span class="crayon-o">:</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-v">IntVal</span><span class="crayon-o">:</span><span class="crayon-cn">6379</span><span class="crayon-h"> </span><span class="crayon-v">StrVal</span><span class="crayon-o">:</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-v">SessionAffinity</span><span class="crayon-o">:</span><span class="crayon-sy">}</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0045 seconds] -->
<p></p>
<p>如上展示的是kubernetes官方guest-example的redis-master的service, 
他的重要参数是Spec这个字段，他包含service portal信息. 
再继续往下进行,下面的代码段将刚收到的services信息和本地已有的通过info, exists := 
proxier.getServiceInfo(service.Name) 函数获得的info作比较. 
如果service有更改,　则在后台重启或使用addServiceOnPort()函数新增代理:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c86851298653" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">activeServices
 := util.StringSet{}
        for _, service := range services {
            activeServices.Insert(service.Name)
            info, exists := proxier.getServiceInfo(service.Name)
            serviceIP := net.ParseIP(service.Spec.PortalIP)
            
            //service 信息完全不变，不做任何操作
            if exists &amp;&amp; info.portalPort == service.Spec.Port 
&amp;&amp; info.portalIP.Equal(serviceIP) {
                continue
            }
            // service 信息发生改变，如portalPort或portalIＰ发生变化时，则重启
            if exists &amp;&amp; (info.portalPort != service.Spec.Port 
|| !info.portalIP.Equal(serviceIP) || !ipsEqual(service.Spec.PublicIPs, 
info.publicIP)) {
                glog.V(4).Infof("Something changed for service %q: 
stopping it", service.Name)
                err := proxier.closePortal(service.Name, info)
                ．．．
                err = proxier.stopProxy(service.Name, info)
                ．．．
            }
            ．．．
            info, err := proxier.addServiceOnPort(service.Name, 
service.Spec.Protocol, service.Spec.ProxyPort, udpIdleTimeout)</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-12">12</div><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-14">14</div><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-16">16</div><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-18">18</div><div class="crayon-num" data-line="crayon-55ed572e63c86851298653-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c86851298653-20">20</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c86851298653-1"><span class="crayon-v">activeServices</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">util</span><span class="crayon-sy">.</span><span class="crayon-v">StringSet</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-h"> </span><span class="crayon-e">services</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c86851298653-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">activeServices</span><span class="crayon-sy">.</span><span class="crayon-e">Insert</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">info</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">exists</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">getServiceInfo</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c86851298653-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">serviceIP</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-e">ParseIP</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-v">PortalIP</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-55ed572e63c86851298653-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//service 信息完全不变，不做任何操作</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">exists</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">portalPort</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-v">Port</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">portalIP</span><span class="crayon-sy">.</span><span class="crayon-e">Equal</span><span class="crayon-sy">(</span><span class="crayon-v">serviceIP</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c86851298653-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63c86851298653-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// service 信息发生改变，如portalPort或portalIＰ发生变化时，则重启</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">exists</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">portalPort</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-v">Port</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">portalIP</span><span class="crayon-sy">.</span><span class="crayon-e">Equal</span><span class="crayon-sy">(</span><span class="crayon-v">serviceIP</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-e">ipsEqual</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-v">PublicIPs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">publicIP</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c86851298653-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">4</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Infof</span><span class="crayon-sy">(</span><span class="crayon-s">"Something changed for service %q: stopping it"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">closePortal</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c86851298653-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">stopProxy</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c86851298653-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63c86851298653-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c86851298653-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">info</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">addServiceOnPort</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-v">Protocol</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-v">ProxyPort</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">udpIdleTimeout</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0119 seconds] -->
<p></p>
<p>其中核心的addServiceOnPort()函数源代码如下, 他的最主要的作用是为每个service开启一个代理socket, 
其中分配一个随机的port号为portNum, 并启动一个goroutine sock.ProxyLoop() 
进行代理循环，这个函数定义在pkg/proxy/proxier.go中，它实现了一个round 
robin代理的逻辑，供读者自行阅读，这里由于篇幅所限不赘述:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c91572539434" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func
 (proxier *Proxier) addServiceOnPort(service string, protocol 
api.Protocol, proxyPort int, timeout time.Duration) (*serviceInfo, 
error) {
    // 新建一个代理socket
    sock, err := newProxySocket(protocol, proxier.listenIP, proxyPort)
    ．．．
    _, portStr, err := net.SplitHostPort(sock.Addr().String())
    ...
    portNum, err := strconv.Atoi(portStr)
    ...
    //将sessionAffinityType设置为None, 默认没有sessionAffinity
    si := &amp;serviceInfo{
        proxyPort:           portNum,
        protocol:            protocol,
        socket:              sock,
        timeout:             timeout,
        sessionAffinityType: api.AffinityTypeNone,
        stickyMaxAgeMinutes: 180,
    }
   　//将新建的serviceInfo保存进proxier的serviceMap数据结构里
    proxier.setServiceInfo(service, si)

    glog.V(1).Infof("Proxying for service %q on %s port %d", service, 
protocol, portNum)
    go func(service string, proxier *Proxier) {
        defer util.HandleCrash()
        sock.ProxyLoop(service, proxier)
    }(service, proxier)

    return si, nil
}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-12">12</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-14">14</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-16">16</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-18">18</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-20">20</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-22">22</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-24">24</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-26">26</div><div class="crayon-num" data-line="crayon-55ed572e63c91572539434-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63c91572539434-28">28</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c91572539434-1"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">proxier *</span><span class="crayon-v">Proxier</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">addServiceOnPort</span><span class="crayon-sy">(</span><span class="crayon-e">service </span><span class="crayon-t">string</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">protocol </span><span class="crayon-v">api</span><span class="crayon-sy">.</span><span class="crayon-v">Protocol</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">proxyPort </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">timeout </span><span class="crayon-v">time</span><span class="crayon-sy">.</span><span class="crayon-v">Duration</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">serviceInfo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 新建一个代理socket</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">sock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">newProxySocket</span><span class="crayon-sy">(</span><span class="crayon-v">protocol</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-v">listenIP</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">proxyPort</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line" id="crayon-55ed572e63c91572539434-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">portStr</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-e">SplitHostPort</span><span class="crayon-sy">(</span><span class="crayon-v">sock</span><span class="crayon-sy">.</span><span class="crayon-e">Addr</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-t">String</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">portNum</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">strconv</span><span class="crayon-sy">.</span><span class="crayon-e">Atoi</span><span class="crayon-sy">(</span><span class="crayon-v">portStr</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//将sessionAffinityType设置为None, 默认没有sessionAffinity</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">si</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-e">serviceInfo</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxyPort</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">portNum</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">protocol</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">protocol</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">socket</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">sock</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">timeout</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">timeout</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">sessionAffinityType</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">api</span><span class="crayon-sy">.</span><span class="crayon-v">AffinityTypeNone</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">stickyMaxAgeMinutes</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">180</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-18"><span class="crayon-h">&nbsp;&nbsp; </span>　<span class="crayon-c">//将新建的serviceInfo保存进proxier的serviceMap数据结构里</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">setServiceInfo</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">si</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-20">&nbsp;</div><div class="crayon-line" id="crayon-55ed572e63c91572539434-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Infof</span><span class="crayon-sy">(</span><span class="crayon-s">"Proxying for service %q on %s port %d"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">protocol</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">portNum</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">go </span><span class="crayon-e">func</span><span class="crayon-sy">(</span><span class="crayon-e">service </span><span class="crayon-t">string</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">proxier *</span><span class="crayon-v">Proxier</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">defer </span><span class="crayon-v">util</span><span class="crayon-sy">.</span><span class="crayon-e">HandleCrash</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">sock</span><span class="crayon-sy">.</span><span class="crayon-e">ProxyLoop</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63c91572539434-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-26">&nbsp;</div><div class="crayon-line" id="crayon-55ed572e63c91572539434-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">si</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">nil</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63c91572539434-28"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0115 seconds] -->
<p></p>
<p>观察后台kube-proxy log 如下, 49263 就是个随机分配的port：</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63c9c414310273" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">I0114 14:50:18.388765   21305 proxier.go:427] Proxying for service "redis-master" on TCP port 49623</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63c9c414310273-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63c9c414310273-1"><span class="crayon-i">I0114</span><span class="crayon-h"> </span><span class="crayon-cn">14</span><span class="crayon-o">:</span><span class="crayon-cn">50</span><span class="crayon-o">:</span><span class="crayon-cn">18.388765</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">21305</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-v">go</span><span class="crayon-o">:</span><span class="crayon-cn">427</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">Proxying </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">service</span><span class="crayon-h"> </span><span class="crayon-s">"redis-master"</span><span class="crayon-h"> </span><span class="crayon-e">on </span><span class="crayon-e">TCP </span><span class="crayon-i">port</span><span class="crayon-h"> </span><span class="crayon-cn">49623</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->
<p></p>
<p>回到OnUpdate函数里，之后将最新的service信息保存到info数据, 　由于proxier.getServiceInfo(service.Name) 返回的是指针, 所以最后实际上保存到了proxier.serviceMap这个数据结构里.</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63ca6783577262" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">info.portalIP = serviceIP
info.portalPort = service.Spec.Port
info.publicIP = service.Spec.PublicIPs
info.sessionAffinityType = service.Spec.SessionAffinity
info.stickyMaxAgeMinutes = 180</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63ca6783577262-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63ca6783577262-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63ca6783577262-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63ca6783577262-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63ca6783577262-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63ca6783577262-1"><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">portalIP</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">serviceIP</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63ca6783577262-2"><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">portalPort</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-e">Port</span></div><div class="crayon-line" id="crayon-55ed572e63ca6783577262-3"><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">publicIP</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-e">PublicIPs</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63ca6783577262-4"><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">sessionAffinityType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-e">SessionAffinity</span></div><div class="crayon-line" id="crayon-55ed572e63ca6783577262-5"><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">stickyMaxAgeMinutes</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">180</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0026 seconds] -->
<p></p>
<p>最后调用openPortal函数打开servicePortal</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63cb0450832907" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">err = proxier.openPortal(service.Name, info)</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63cb0450832907-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63cb0450832907-1"><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">openPortal</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->
<p></p>
<p>他实际调用的是如下的openOnePortal函数,他的源码如下,定义在pkg/proxy/proxier.go中</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63cb9710672179" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func
 (proxier *Proxier) openOnePortal(portalIP net.IP, portalPort int, 
protocol api.Protocol, proxyIP net.IP, proxyPort int, name string) error
 {
        // 处理containers之间的流量.
        args := proxier.iptablesContainerPortalArgs(portalIP, 
portalPort, protocol, proxyIP, proxyPort, name)
        existed, err := proxier.iptables.EnsureRule(iptables.TableNAT, 
iptablesContainerPortalChain, args...)
        ．．．
        if !existed {
            glog.Infof("Opened iptables from-containers portal for 
service %q on %s %s:%d", name, protocol, portalIP, portalPort)
        ｝  
        ．．．
    }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63cb9710672179-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cb9710672179-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63cb9710672179-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cb9710672179-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63cb9710672179-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cb9710672179-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63cb9710672179-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cb9710672179-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63cb9710672179-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cb9710672179-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63cb9710672179-1"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">proxier *</span><span class="crayon-v">Proxier</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">openOnePortal</span><span class="crayon-sy">(</span><span class="crayon-e">portalIP </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-v">IP</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">portalPort </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">protocol </span><span class="crayon-v">api</span><span class="crayon-sy">.</span><span class="crayon-v">Protocol</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">proxyIP </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-v">IP</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">proxyPort </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-t">string</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">error</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cb9710672179-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 处理containers之间的流量.</span></div><div class="crayon-line" id="crayon-55ed572e63cb9710672179-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">iptablesContainerPortalArgs</span><span class="crayon-sy">(</span><span class="crayon-v">portalIP</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">portalPort</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">protocol</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">proxyIP</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">proxyPort</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cb9710672179-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">existed</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-e">EnsureRule</span><span class="crayon-sy">(</span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-v">TableNAT</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">iptablesContainerPortalChain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63cb9710672179-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cb9710672179-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-e">existed</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63cb9710672179-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">Infof</span><span class="crayon-sy">(</span><span class="crayon-s">"Opened iptables from-containers portal for service %q on %s %s:%d"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">protocol</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">portalIP</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">portalPort</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cb9710672179-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>｝<span class="crayon-h">&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-55ed572e63cb9710672179-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cb9710672179-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0065 seconds] -->
<p></p>
<p>他的作用是保证根据上文的service信息添加了正确的iptables rule,　并将相应的规则添加到iptables NAT表里, 最后调用的是pkg/util/iptables/iptables.go中的run函数,源代码如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63cc3640636265" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func (runner *runner) run(op operation, args []string) ([]byte, error) {
    iptablesCmd := runner.iptablesCommand()

    fullArgs := append([]string{string(op)}, args...)
    glog.V(1).Infof("running iptables %s %v", string(op), args)
    return runner.exec.Command(iptablesCmd, fullArgs...).CombinedOutput()

}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63cc3640636265-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cc3640636265-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63cc3640636265-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cc3640636265-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63cc3640636265-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cc3640636265-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63cc3640636265-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cc3640636265-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63cc3640636265-1"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">runner *</span><span class="crayon-v">runner</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-e">op </span><span class="crayon-v">operation</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">args</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">string</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">byte</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cc3640636265-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">iptablesCmd</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">runner</span><span class="crayon-sy">.</span><span class="crayon-e">iptablesCommand</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63cc3640636265-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cc3640636265-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">fullArgs</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">string</span><span class="crayon-sy">{</span><span class="crayon-t">string</span><span class="crayon-sy">(</span><span class="crayon-v">op</span><span class="crayon-sy">)</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63cc3640636265-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Infof</span><span class="crayon-sy">(</span><span class="crayon-s">"running iptables %s %v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">(</span><span class="crayon-v">op</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cc3640636265-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">runner</span><span class="crayon-sy">.</span><span class="crayon-v">exec</span><span class="crayon-sy">.</span><span class="crayon-e">Command</span><span class="crayon-sy">(</span><span class="crayon-v">iptablesCmd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">fullArgs</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">CombinedOutput</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63cc3640636265-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cc3640636265-8"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0056 seconds] -->
<p></p>
<p>从后台的kube-proxy log中可以看到下面的iptables操作</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63ccd407340133" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">I0112
 12:38:03.870741    7284 iptables.go:169] running iptables -N 
[KUBE-PROXY -t nat]
 I0112 12:38:03.877783    7284 iptables.go:169] running iptables -C 
[PREROUTING -t nat -j KUBE-PROXY]
 I0112 12:38:03.885954    7284 iptables.go:169] running iptables -C 
[OUTPUT -t nat -j KUBE-PROXY]
 I0112 12:38:03.893237    7284 iptables.go:169] running iptables -C 
[KUBE-PROXY -t nat -m comment --comment redis-master -p tcp -m tcp -d 
11.1.1.83/32 --dport 6379 -j REDIRECT --to-ports 37292]
 I0112 12:38:03.904520    7284 iptables.go:169] running iptables -C 
[KUBE-PROXY -t nat -m comment --comment redisslave -p tcp -m tcp -d 
11.1.1.176/32 --dport 6379 -j REDIRECT --to-ports 37334]</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63ccd407340133-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63ccd407340133-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63ccd407340133-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63ccd407340133-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63ccd407340133-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63ccd407340133-1"><span class="crayon-i">I0112</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-cn">38</span><span class="crayon-o">:</span><span class="crayon-cn">03.870741</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">7284</span><span class="crayon-h"> </span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-v">go</span><span class="crayon-o">:</span><span class="crayon-cn">169</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">running </span><span class="crayon-v">iptables</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">N</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">PROXY</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">nat</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63ccd407340133-2"><span class="crayon-h"> </span><span class="crayon-i">I0112</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-cn">38</span><span class="crayon-o">:</span><span class="crayon-cn">03.877783</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">7284</span><span class="crayon-h"> </span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-v">go</span><span class="crayon-o">:</span><span class="crayon-cn">169</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">running </span><span class="crayon-v">iptables</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">C</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">PREROUTING</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">nat</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">PROXY</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-55ed572e63ccd407340133-3"><span class="crayon-h"> </span><span class="crayon-i">I0112</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-cn">38</span><span class="crayon-o">:</span><span class="crayon-cn">03.885954</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">7284</span><span class="crayon-h"> </span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-v">go</span><span class="crayon-o">:</span><span class="crayon-cn">169</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">running </span><span class="crayon-v">iptables</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">C</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">OUTPUT</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">nat</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">PROXY</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63ccd407340133-4"><span class="crayon-h"> </span><span class="crayon-i">I0112</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-cn">38</span><span class="crayon-o">:</span><span class="crayon-cn">03.893237</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">7284</span><span class="crayon-h"> </span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-v">go</span><span class="crayon-o">:</span><span class="crayon-cn">169</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">running </span><span class="crayon-v">iptables</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">C</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">PROXY</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">nat</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">comment</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">comment </span><span class="crayon-v">redis</span><span class="crayon-o">-</span><span class="crayon-v">master</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-v">tcp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">tcp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-cn">11.1.1.83</span><span class="crayon-o">/</span><span class="crayon-cn">32</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">dport</span><span class="crayon-h"> </span><span class="crayon-cn">6379</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-v">REDIRECT</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-st">to</span><span class="crayon-o">-</span><span class="crayon-i">ports</span><span class="crayon-h"> </span><span class="crayon-cn">37292</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-55ed572e63ccd407340133-5"><span class="crayon-h"> </span><span class="crayon-i">I0112</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-cn">38</span><span class="crayon-o">:</span><span class="crayon-cn">03.904520</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">7284</span><span class="crayon-h"> </span><span class="crayon-v">iptables</span><span class="crayon-sy">.</span><span class="crayon-v">go</span><span class="crayon-o">:</span><span class="crayon-cn">169</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">running </span><span class="crayon-v">iptables</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">C</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">PROXY</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">nat</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">comment</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">comment </span><span class="crayon-v">redisslave</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-v">tcp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">tcp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-cn">11.1.1.176</span><span class="crayon-o">/</span><span class="crayon-cn">32</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">dport</span><span class="crayon-h"> </span><span class="crayon-cn">6379</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-v">REDIRECT</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-st">to</span><span class="crayon-o">-</span><span class="crayon-i">ports</span><span class="crayon-h"> </span><span class="crayon-cn">37334</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0128 seconds] -->
<p></p>
<p>使用命令$ iptables -t nat -L 可以看到结果如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63cd7143012922" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">Chain KUBE-PROXY (2 references)
target     prot opt source               destination         
REDIRECT   tcp  --  anywhere             11.1.1.83            /* redis-master */ tcp dpt:6379 redir ports 37292
REDIRECT   tcp  --  anywhere             11.1.1.176           /* redisslave */ tcp dpt:6379 redir ports 37334
REDIRECT   tcp  --  anywhere             11.1.1.1             /* redis-master2 */ tcp dpt:6379 redir ports 41074
REDIRECT   tcp  --  anywhere             11.1.1.169           /* kubernetes */ tcp dpt:https redir ports 54541
REDIRECT   tcp  --  anywhere             11.1.1.91            /* kubernetes-ro */ tcp dpt:http redir ports 35201</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63cd7143012922-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cd7143012922-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63cd7143012922-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cd7143012922-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63cd7143012922-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cd7143012922-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63cd7143012922-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63cd7143012922-1"><span class="crayon-e">Chain </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-e">PROXY</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-v">references</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cd7143012922-2"><span class="crayon-e">target&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">prot </span><span class="crayon-e">opt </span><span class="crayon-e">source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-55ed572e63cd7143012922-3"><span class="crayon-e">REDIRECT&nbsp;&nbsp; </span><span class="crayon-v">tcp</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">anywhere</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">11.1.1.83</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">/* redis-master */</span><span class="crayon-h"> </span><span class="crayon-e">tcp </span><span class="crayon-v">dpt</span><span class="crayon-o">:</span><span class="crayon-cn">6379</span><span class="crayon-h"> </span><span class="crayon-e">redir </span><span class="crayon-i">ports</span><span class="crayon-h"> </span><span class="crayon-cn">37292</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cd7143012922-4"><span class="crayon-e">REDIRECT&nbsp;&nbsp; </span><span class="crayon-v">tcp</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">anywhere</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">11.1.1.176</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/* redisslave */</span><span class="crayon-h"> </span><span class="crayon-e">tcp </span><span class="crayon-v">dpt</span><span class="crayon-o">:</span><span class="crayon-cn">6379</span><span class="crayon-h"> </span><span class="crayon-e">redir </span><span class="crayon-i">ports</span><span class="crayon-h"> </span><span class="crayon-cn">37334</span></div><div class="crayon-line" id="crayon-55ed572e63cd7143012922-5"><span class="crayon-e">REDIRECT&nbsp;&nbsp; </span><span class="crayon-v">tcp</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">anywhere</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">11.1.1.1</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/* redis-master2 */</span><span class="crayon-h"> </span><span class="crayon-e">tcp </span><span class="crayon-v">dpt</span><span class="crayon-o">:</span><span class="crayon-cn">6379</span><span class="crayon-h"> </span><span class="crayon-e">redir </span><span class="crayon-i">ports</span><span class="crayon-h"> </span><span class="crayon-cn">41074</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cd7143012922-6"><span class="crayon-e">REDIRECT&nbsp;&nbsp; </span><span class="crayon-v">tcp</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">anywhere</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">11.1.1.169</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/* kubernetes */</span><span class="crayon-h"> </span><span class="crayon-e">tcp </span><span class="crayon-v">dpt</span><span class="crayon-o">:</span><span class="crayon-e">https </span><span class="crayon-e">redir </span><span class="crayon-i">ports</span><span class="crayon-h"> </span><span class="crayon-cn">54541</span></div><div class="crayon-line" id="crayon-55ed572e63cd7143012922-7"><span class="crayon-e">REDIRECT&nbsp;&nbsp; </span><span class="crayon-v">tcp</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">anywhere</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">11.1.1.91</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">/* kubernetes-ro */</span><span class="crayon-h"> </span><span class="crayon-e">tcp </span><span class="crayon-v">dpt</span><span class="crayon-o">:</span><span class="crayon-e">http </span><span class="crayon-e">redir </span><span class="crayon-i">ports</span><span class="crayon-h"> </span><span class="crayon-cn">35201</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0067 seconds] -->
<p></p>
<p>可以看到minion主机上的iptable新增了KUBE-PROXY CHAIN , 并且采用的是REDIRECT target. 
这个CHAIN有两个引用, 分别是PREROUTING 和 OUTPUT CHAIN. 
最后的结果是容器里的应用如果想通过11.1.1.176：6379 
访问redisslave服务时,流量被REDIRECT到了本机的37334端口, 
通过这个本地37334端口，再使用刚刚说到的每个service提供的代理socket导向到真正后端. 如下面的终端输出所示.这里的 
11.1.1.176相当于一个虚拟的ip. 这个ip范围可在启动 kube-apiserver时指定portal_net参数指定.</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63ce2220776556" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">vcap@224:~$ nc -zv 11.1.1.176 6379
Connection to 11.1.1.176 6379 port [tcp/*] succeeded!</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63ce2220776556-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63ce2220776556-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63ce2220776556-1"><span class="crayon-v">vcap</span><span class="crayon-sy">@</span><span class="crayon-cn">224</span><span class="crayon-o">:</span><span class="crayon-o">~</span><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">nc</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">zv</span><span class="crayon-h"> </span><span class="crayon-cn">11.1.1.176</span><span class="crayon-h"> </span><span class="crayon-cn">6379</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63ce2220776556-2"><span class="crayon-e">Connection </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-cn">11.1.1.176</span><span class="crayon-h"> </span><span class="crayon-cn">6379</span><span class="crayon-h"> </span><span class="crayon-i">port</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">tcp</span><span class="crayon-o">/</span><span class="crayon-o">*</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">succeeded</span><span class="crayon-o">!</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->
<p></p>
<p>再使用proxier.loadBalancer.NewService函数</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63cec533213834" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">proxier.loadBalancer.NewService(service.Name, info.sessionAffinityType, info.stickyMaxAgeMinutes)</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63cec533213834-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63cec533213834-1"><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-v">loadBalancer</span><span class="crayon-sy">.</span><span class="crayon-e">NewService</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">sessionAffinityType</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">.</span><span class="crayon-v">stickyMaxAgeMinutes</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->
<p></p>
<p>源代码定义在pkg/proxy/roundrobin.go中,源代码如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63cf5370762034" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func (lb *LoadBalancerRR) NewService(service string, sessionAffinityType api.AffinityType, stickyMaxAgeMinutes int) error {
        if stickyMaxAgeMinutes == 0 {
            stickyMaxAgeMinutes = 180 //单位分钟
    　　　}
        if _, exists := lb.serviceDtlMap[service]; !exists {
            lb.serviceDtlMap[service] = *newServiceDetail(service, sessionAffinityType, stickyMaxAgeMinutes)
            glog.V(4).Infof("NewService.  Service does not exist.  So I created it: %+v", lb.serviceDtlMap[service])
        }
        return nil
    }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63cf5370762034-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cf5370762034-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63cf5370762034-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cf5370762034-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63cf5370762034-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cf5370762034-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63cf5370762034-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cf5370762034-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63cf5370762034-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63cf5370762034-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63cf5370762034-1"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">lb *</span><span class="crayon-v">LoadBalancerRR</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">NewService</span><span class="crayon-sy">(</span><span class="crayon-e">service </span><span class="crayon-t">string</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">sessionAffinityType </span><span class="crayon-v">api</span><span class="crayon-sy">.</span><span class="crayon-v">AffinityType</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">stickyMaxAgeMinutes </span><span class="crayon-t">int</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">error</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cf5370762034-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">stickyMaxAgeMinutes</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63cf5370762034-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">stickyMaxAgeMinutes</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">180</span><span class="crayon-h"> </span><span class="crayon-c">//单位分钟</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cf5370762034-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>　　　<span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63cf5370762034-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">exists</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">lb</span><span class="crayon-sy">.</span><span class="crayon-v">serviceDtlMap</span><span class="crayon-sy">[</span><span class="crayon-v">service</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-e">exists</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cf5370762034-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">lb</span><span class="crayon-sy">.</span><span class="crayon-v">serviceDtlMap</span><span class="crayon-sy">[</span><span class="crayon-v">service</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-e">newServiceDetail</span><span class="crayon-sy">(</span><span class="crayon-v">service</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sessionAffinityType</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stickyMaxAgeMinutes</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63cf5370762034-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">4</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Infof</span><span class="crayon-sy">(</span><span class="crayon-s">"NewService.&nbsp;&nbsp;Service does not exist.&nbsp;&nbsp;So I created it: %+v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">lb</span><span class="crayon-sy">.</span><span class="crayon-v">serviceDtlMap</span><span class="crayon-sy">[</span><span class="crayon-v">service</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cf5370762034-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63cf5370762034-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-i">nil</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63cf5370762034-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0064 seconds] -->
<p></p>
<p>可以看到一个很重要的操作是维护serviceDtlMap这样一个golang map数据结构, key是相应service name. 
这里sessionAffinityType有基于clientIPAddress的方式，也有最普通的None模式，也就是常用的round 
robin方式无sessionAffinity, 
如下面的log就是创建了一个名为redis-master的sessionAffinityType为 None的 service.</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63cff908072631" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">I0112
 12:37:53.824530    7284 roundrobin.go:83] NewService.  Service does not
 exist.  So I created it: {name:redis-master sessionAffinityType:None 
sessionAffinityMap:map[] stickyMaxAgeMinutes:180}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63cff908072631-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63cff908072631-1"><span class="crayon-i">I0112</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-cn">37</span><span class="crayon-o">:</span><span class="crayon-cn">53.824530</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">7284</span><span class="crayon-h"> </span><span class="crayon-v">roundrobin</span><span class="crayon-sy">.</span><span class="crayon-v">go</span><span class="crayon-o">:</span><span class="crayon-cn">83</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">NewService</span><span class="crayon-sy">.</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">Service </span><span class="crayon-e">does </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">exist</span><span class="crayon-sy">.</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">So</span><span class="crayon-h"> </span><span class="crayon-i">I</span><span class="crayon-h"> </span><span class="crayon-e">created </span><span class="crayon-v">it</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">name</span><span class="crayon-o">:</span><span class="crayon-v">redis</span><span class="crayon-o">-</span><span class="crayon-e">master </span><span class="crayon-v">sessionAffinityType</span><span class="crayon-o">:</span><span class="crayon-e">None </span><span class="crayon-v">sessionAffinityMap</span><span class="crayon-o">:</span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">stickyMaxAgeMinutes</span><span class="crayon-o">:</span><span class="crayon-cn">180</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0032 seconds] -->
<p></p>
<p>OnUpdate函数最后的活动是对未活动的service, 即要被删除掉的service 关闭portal,　删除指定的iptables rule,　关闭代理套接字.　代码如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63d09141250249" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">　　proxier.mu.Lock()
　　defer proxier.mu.Unlock()
　　for name, info := range proxier.serviceMap {
        if !activeServices.Has(name) {
            ．．．
            err := proxier.closePortal(name, info)
            ．．．
            err = proxier.stopProxyInternal(name, info)
            ．．．
        }
    }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63d09141250249-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d09141250249-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63d09141250249-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d09141250249-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63d09141250249-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d09141250249-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63d09141250249-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d09141250249-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63d09141250249-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d09141250249-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63d09141250249-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63d09141250249-1">　　<span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-v">mu</span><span class="crayon-sy">.</span><span class="crayon-e">Lock</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d09141250249-2">　　<span class="crayon-e">defer </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-v">mu</span><span class="crayon-sy">.</span><span class="crayon-e">Unlock</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63d09141250249-3">　　<span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">range </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-i">serviceMap</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d09141250249-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-v">activeServices</span><span class="crayon-sy">.</span><span class="crayon-e">Has</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d09141250249-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d09141250249-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">closePortal</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63d09141250249-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d09141250249-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">stopProxyInternal</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">info</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63d09141250249-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d09141250249-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63d09141250249-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0047 seconds] -->
<p></p>
<p><strong>7.回到main函数，下一步指定变化的源 ,一般采用etcd_server ,即调用下面代码的else部分</strong></p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63d13217225095" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">if clientConfig.Host != "" {
        ．．．
    } else {
        var etcdClient *etcd.Client

        // 创建 etcd client
        if len(etcdServerList) &gt; 0 {
            ...
            etcdClient = etcd.NewClient(etcdServerList)
        } ．．．
        
        if etcdClient != nil {
            glog.Infof("Using etcd servers %v", etcdClient.GetCluster())

            config.NewConfigSourceEtcd(etcdClient,
                serviceConfig.Channel("etcd"),
                endpointsConfig.Channel("etcd"))
        }
    }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d13217225095-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d13217225095-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d13217225095-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d13217225095-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d13217225095-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d13217225095-12">12</div><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d13217225095-14">14</div><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d13217225095-16">16</div><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d13217225095-18">18</div><div class="crayon-num" data-line="crayon-55ed572e63d13217225095-19">19</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63d13217225095-1"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">clientConfig</span><span class="crayon-sy">.</span><span class="crayon-v">Host</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d13217225095-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line" id="crayon-55ed572e63d13217225095-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d13217225095-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-e ">etcdClient *</span><span class="crayon-v">etcd</span><span class="crayon-sy">.</span><span class="crayon-v">Client</span></div><div class="crayon-line" id="crayon-55ed572e63d13217225095-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d13217225095-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 创建 etcd client</span></div><div class="crayon-line" id="crayon-55ed572e63d13217225095-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">etcdServerList</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d13217225095-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-55ed572e63d13217225095-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">etcdClient</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">etcd</span><span class="crayon-sy">.</span><span class="crayon-e">NewClient</span><span class="crayon-sy">(</span><span class="crayon-v">etcdServerList</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d13217225095-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span>．．．</div><div class="crayon-line" id="crayon-55ed572e63d13217225095-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d13217225095-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">etcdClient</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d13217225095-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">Infof</span><span class="crayon-sy">(</span><span class="crayon-s">"Using etcd servers %v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">etcdClient</span><span class="crayon-sy">.</span><span class="crayon-e">GetCluster</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d13217225095-14">&nbsp;</div><div class="crayon-line" id="crayon-55ed572e63d13217225095-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">NewConfigSourceEtcd</span><span class="crayon-sy">(</span><span class="crayon-v">etcdClient</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d13217225095-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">serviceConfig</span><span class="crayon-sy">.</span><span class="crayon-e">Channel</span><span class="crayon-sy">(</span><span class="crayon-s">"etcd"</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63d13217225095-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">endpointsConfig</span><span class="crayon-sy">.</span><span class="crayon-e">Channel</span><span class="crayon-sy">(</span><span class="crayon-s">"etcd"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d13217225095-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63d13217225095-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0063 seconds] -->
<p></p>
<p>流程为 7.1 先使用给定的命令行参数etcd_servers 创建一个新的etcdClient对象, 使用的pkg是coreos的github.com/coreos/go-etcd/etcd pkg. 查看后端kube-proxy的log如下</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63d1d537303626" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">I0107 10:30:25.561301    5921 proxy.go:117] Using etcd servers [http://127.0.0.1:4001]</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63d1d537303626-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63d1d537303626-1"><span class="crayon-i">I0107</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">30</span><span class="crayon-o">:</span><span class="crayon-cn">25.561301</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">5921</span><span class="crayon-h"> </span><span class="crayon-v">proxy</span><span class="crayon-sy">.</span><span class="crayon-v">go</span><span class="crayon-o">:</span><span class="crayon-cn">117</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">Using </span><span class="crayon-e">etcd </span><span class="crayon-i">servers</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//127.0.0.1:4001]</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->
<p></p>
<p>7.2 之后使用config.NewConfigSourceEtcd(etcdClient, 
serviceConfig.Channel(“etcd”), endpointsConfig.Channel(“etcd”))函数. 
注意到这个函数的后两个参数是serviceConfig.Channel(“etcd”)和
endpointsConfig.Channel(“etcd”)的返回值. 
这两个函数除了make创建出相应的channel之外还做了一些额外的操作值得注意! 
下面介绍其中的一个serviceConfig.Channel(“etcd”),　endpointsConfig.Channel(“etcd”)雷
同.</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63d27422940306" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func (c *ServiceConfig) Channel(source string) chan ServiceUpdate {
    ch := c.mux.Channel(source)
    serviceCh := make(chan ServiceUpdate)
    go func() {
        for update := range serviceCh {
            ch &lt;- update
        }
        close(ch)
    }()
    return serviceCh
}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63d27422940306-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d27422940306-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63d27422940306-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d27422940306-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63d27422940306-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d27422940306-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63d27422940306-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d27422940306-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63d27422940306-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d27422940306-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63d27422940306-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63d27422940306-1"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">c *</span><span class="crayon-v">ServiceConfig</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">Channel</span><span class="crayon-sy">(</span><span class="crayon-e">source </span><span class="crayon-t">string</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">chan</span><span class="crayon-h"> </span><span class="crayon-e">ServiceUpdate</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d27422940306-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">ch</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-v">mux</span><span class="crayon-sy">.</span><span class="crayon-e">Channel</span><span class="crayon-sy">(</span><span class="crayon-v">source</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63d27422940306-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">serviceCh</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">make</span><span class="crayon-sy">(</span><span class="crayon-e">chan </span><span class="crayon-v">ServiceUpdate</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d27422940306-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">go </span><span class="crayon-e">func</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d27422940306-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">update</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-h"> </span><span class="crayon-e">serviceCh</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d27422940306-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">ch</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">update</span></div><div class="crayon-line" id="crayon-55ed572e63d27422940306-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d27422940306-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-v">ch</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63d27422940306-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d27422940306-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-i">serviceCh</span></div><div class="crayon-line" id="crayon-55ed572e63d27422940306-11"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0047 seconds] -->
<p></p>
<p>他调用Mux里的Channel函数创建一个新的channel ch,　并且创建一个传送ServiceUpdate 的channel 
serviceCh, 一旦serviceCh有可用的信息如update就将他写入ch. 
之后再回来看一下ConfigSourceEtcd结构体和相关的NewConfigSourceEtcd函数，它的源代码定义在pkg/proxy
/config/etcd.go, 代码如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63d3d964295952" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">type
 ConfigSourceEtcd struct {
        client           *etcd.Client
        serviceChannel   chan ServiceUpdate
        endpointsChannel chan EndpointsUpdate
        interval         time.Duration
    ｝
 　func NewConfigSourceEtcd(client *etcd.Client, serviceChannel chan 
ServiceUpdate, endpointsChannel chan EndpointsUpdate) ConfigSourceEtcd {
        config := ConfigSourceEtcd{
            client:           client,
            serviceChannel:   serviceChannel,
            endpointsChannel: endpointsChannel,
            interval:         2 * time.Second,
        }
        go config.Run()
        return config
    }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63d3d964295952-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d3d964295952-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63d3d964295952-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d3d964295952-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63d3d964295952-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d3d964295952-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63d3d964295952-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d3d964295952-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63d3d964295952-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d3d964295952-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63d3d964295952-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d3d964295952-12">12</div><div class="crayon-num" data-line="crayon-55ed572e63d3d964295952-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d3d964295952-14">14</div><div class="crayon-num" data-line="crayon-55ed572e63d3d964295952-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d3d964295952-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63d3d964295952-1"><span class="crayon-e">type</span><span class="crayon-h"> </span><span class="crayon-e">ConfigSourceEtcd</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d3d964295952-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e ">client&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</span><span class="crayon-v">etcd</span><span class="crayon-sy">.</span><span class="crayon-e">Client</span></div><div class="crayon-line" id="crayon-55ed572e63d3d964295952-3"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serviceChannel&nbsp;&nbsp; </span><span class="crayon-e">chan </span><span class="crayon-e">ServiceUpdate</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d3d964295952-4"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">endpointsChannel </span><span class="crayon-e">chan </span><span class="crayon-e">EndpointsUpdate</span></div><div class="crayon-line" id="crayon-55ed572e63d3d964295952-5"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">interval&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">time</span><span class="crayon-sy">.</span><span class="crayon-i">Duration</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d3d964295952-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>｝</div><div class="crayon-line" id="crayon-55ed572e63d3d964295952-7"><span class="crayon-h"> </span>　<span class="crayon-e">func </span><span class="crayon-e">NewConfigSourceEtcd</span><span class="crayon-sy">(</span><span class="crayon-e ">client *</span><span class="crayon-v">etcd</span><span class="crayon-sy">.</span><span class="crayon-v">Client</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">serviceChannel </span><span class="crayon-e">chan </span><span class="crayon-v">ServiceUpdate</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">endpointsChannel </span><span class="crayon-e">chan </span><span class="crayon-v">EndpointsUpdate</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">ConfigSourceEtcd</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d3d964295952-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">ConfigSourceEtcd</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d3d964295952-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">client</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d3d964295952-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">serviceChannel</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">serviceChannel</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63d3d964295952-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">endpointsChannel</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">endpointsChannel</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d3d964295952-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">interval</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">time</span><span class="crayon-sy">.</span><span class="crayon-v">Second</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-55ed572e63d3d964295952-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d3d964295952-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">go </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">Run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63d3d964295952-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-i">config</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d3d964295952-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0057 seconds] -->
<p></p>
<p>NewConfigSourceEtcd作用是创建一个新的ConfigSourceEtcd结构体, 
这个结构体里封装了etcdClient和两个传输信息的Channel: 1 serviceChannel 2 
endpointsChannel.并启动一个goroutine config.Run()函数.源代码如下:</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63d4a905821729" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">// Run函数watch　etcd 上与service 和endpoint相关的key的变化，并将新的处理好的serviceUpdate和endpointUpate值输出到指定channel
// 如刚刚提到的1 serviceChannel 2 endpointsChannel.
func (s ConfigSourceEtcd) Run() {
　　　　．．．
    for {
    　　// 通过查询etcd上/registry/services/specs下的相关key获得service 和endpoint列表
        services, endpoints, err = s.GetServices()
        if err != nil {
            ．．．
    　　} else {
         　// 传输到相应channel，如刚刚说到的(c *ServiceConfig) Channel函数里的所谓serviceCh　channel
            if len(services) &gt; 0 {
                serviceUpdate := ServiceUpdate{Op: SET, Services: services}
                s.serviceChannel &lt;- serviceUpdate
            }
            ...

        }
        time.Sleep(30 * time.Second)
    }
}
</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-12">12</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-14">14</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-16">16</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-18">18</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-20">20</div><div class="crayon-num" data-line="crayon-55ed572e63d4a905821729-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d4a905821729-22">22</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63d4a905821729-1"><span class="crayon-c">// Run函数watch　etcd 上与service 和endpoint相关的key的变化，并将新的处理好的serviceUpdate和endpointUpate值输出到指定channel</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-2"><span class="crayon-c">// 如刚刚提到的1 serviceChannel 2 endpointsChannel.</span></div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-3"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-v">ConfigSourceEtcd</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">Run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-4">　　　　．．．</div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>　　<span class="crayon-c">// 通过查询etcd上/registry/services/specs下的相关key获得service 和endpoint列表</span></div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">services</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">endpoints</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-e">GetServices</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>．．．</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>　　<span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>　<span class="crayon-c">// 传输到相应channel，如刚刚说到的(c *ServiceConfig) Channel函数里的所谓serviceCh　channel</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">services</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">serviceUpdate</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">ServiceUpdate</span><span class="crayon-sy">{</span><span class="crayon-v">Op</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">SET</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Services</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">services</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-v">serviceChannel</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">serviceUpdate</span></div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-17">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">time</span><span class="crayon-sy">.</span><span class="crayon-e">Sleep</span><span class="crayon-sy">(</span><span class="crayon-cn">30</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">time</span><span class="crayon-sy">.</span><span class="crayon-v">Second</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63d4a905821729-21"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d4a905821729-22">&nbsp;</div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0071 seconds] -->
<p></p>
<p><strong>8.启动health监控</strong></p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63d55808003810" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">if *healthz_port &gt; 0 {
            go util.Forever(func() {
                err := http.ListenAndServe(bindAddress.String()+":"+strconv.Itoa(*healthz_port), nil)
                if err != nil {
                    glog.Errorf("Starting health server failed: %v", err)
                }
            }, 5*time.Second)
        }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63d55808003810-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d55808003810-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63d55808003810-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d55808003810-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63d55808003810-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d55808003810-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63d55808003810-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d55808003810-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63d55808003810-1"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-e">healthz_port</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d55808003810-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">go </span><span class="crayon-v">util</span><span class="crayon-sy">.</span><span class="crayon-e">Forever</span><span class="crayon-sy">(</span><span class="crayon-e">func</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d55808003810-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">ListenAndServe</span><span class="crayon-sy">(</span><span class="crayon-v">bindAddress</span><span class="crayon-sy">.</span><span class="crayon-t">String</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-s">":"</span><span class="crayon-o">+</span><span class="crayon-v">strconv</span><span class="crayon-sy">.</span><span class="crayon-e">Itoa</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">healthz_port</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nil</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d55808003810-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d55808003810-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">Errorf</span><span class="crayon-sy">(</span><span class="crayon-s">"Starting health server failed: %v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d55808003810-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63d55808003810-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-o">*</span><span class="crayon-v">time</span><span class="crayon-sy">.</span><span class="crayon-v">Second</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d55808003810-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0047 seconds] -->
<p></p>
<p>目前什么http的HandleFunc都没有,访问healthz_port会遇到404 not found error.</p>
<p><strong>9.最后调用SyncLoop()</strong></p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63d5f443294146" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">// Just loop forever for now...
    proxier.SyncLoop()</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63d5f443294146-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d5f443294146-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63d5f443294146-1"><span class="crayon-c">// Just loop forever for now...</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d5f443294146-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">SyncLoop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p></p>
<p>其源代码定义在pkg/proxy/proxier.go中，如下：</p>
<p></p><!-- Crayon Syntax Highlighter v2.6.9 -->

		<div id="crayon-55ed572e63d68646404353" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px ! important; line-height: 15px ! important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px ! important; height: 18px ! important; line-height: 18px ! important; margin-top: -19px; display: none; position: absolute; z-index: 2;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div style="display: none;" class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px ! important; line-height: 15px ! important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">func (proxier *Proxier) SyncLoop() {
    for {
        select {
        // 每隔syncInterval　默认值是５s进行一次，保证iptables设置及portal正常工作
        // 并清理除AffinityTypeNone之外的超时session
        case &lt;-time.After(syncInterval):
            glog.V(2).Infof("Periodic sync")
            if err := iptablesInit(proxier.iptables); err != nil {
                glog.Errorf("Failed to ensure iptables: %v", err)
            }
            proxier.ensurePortals()
            proxier.cleanupStaleStickySessions()
        }
    }
}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table style="" class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-55ed572e63d68646404353-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d68646404353-2">2</div><div class="crayon-num" data-line="crayon-55ed572e63d68646404353-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d68646404353-4">4</div><div class="crayon-num" data-line="crayon-55ed572e63d68646404353-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d68646404353-6">6</div><div class="crayon-num" data-line="crayon-55ed572e63d68646404353-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d68646404353-8">8</div><div class="crayon-num" data-line="crayon-55ed572e63d68646404353-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d68646404353-10">10</div><div class="crayon-num" data-line="crayon-55ed572e63d68646404353-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d68646404353-12">12</div><div class="crayon-num" data-line="crayon-55ed572e63d68646404353-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-55ed572e63d68646404353-14">14</div><div class="crayon-num" data-line="crayon-55ed572e63d68646404353-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-55ed572e63d68646404353-1"><span class="crayon-e">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">proxier *</span><span class="crayon-v">Proxier</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">SyncLoop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d68646404353-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d68646404353-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">select</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d68646404353-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 每隔syncInterval　默认值是５s进行一次，保证iptables设置及portal正常工作</span></div><div class="crayon-line" id="crayon-55ed572e63d68646404353-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 并清理除AffinityTypeNone之外的超时session</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d68646404353-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">-</span><span class="crayon-v">time</span><span class="crayon-sy">.</span><span class="crayon-e">After</span><span class="crayon-sy">(</span><span class="crayon-v">syncInterval</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-55ed572e63d68646404353-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Infof</span><span class="crayon-sy">(</span><span class="crayon-s">"Periodic sync"</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d68646404353-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">iptablesInit</span><span class="crayon-sy">(</span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-v">iptables</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-55ed572e63d68646404353-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">glog</span><span class="crayon-sy">.</span><span class="crayon-e">Errorf</span><span class="crayon-sy">(</span><span class="crayon-s">"Failed to ensure iptables: %v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d68646404353-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63d68646404353-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">ensurePortals</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d68646404353-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxier</span><span class="crayon-sy">.</span><span class="crayon-e">cleanupStaleStickySessions</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-55ed572e63d68646404353-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-55ed572e63d68646404353-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-55ed572e63d68646404353-15"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0055 seconds] -->
<p></p>
<p><strong>总结:</strong></p>
<p>1 每个Kubernetes节点都运行一个kube-proxy这么一个服务代理,它 watch kubernetes 集群里 
service 和 endpoints(label是某一特定条件的pods)这两个对象的增加或删除,　并且维护一个service 到 
endpoints的映射. 他使用iptables REDIRECT 
target将对服务的请求流量转接到本地的一个port上,　然后再将流量发到后端,　这样的转发还支持一些策略,　如round 
robin等，所以我们可以把他看成是一个具有高级功能的反向代理.</p>
<p>2 下面为Kube-proxy内部goroutine及channel 使用图，以service信息传递为例</p>
<p><a href="http://www.sel.zju.edu.cn/wp-content/uploads/2015/01/serviceChannel.png"><img src="index_files/serviceChannel.png" alt="serviceChannel" class="alignnone size-full wp-image-490" height="365" width="974"></a></p>
<div style="margin-top: 15px; font-style: italic">
<p>浙江大学SEL实验室是本网站上所有页面设计、页面内容的著作权人，对该网站所载的作品，包括但不限于网站所载的文字、数据、图形、照片、有声文
件、动画文件、音视频资料等拥有完整的版权，受著作权法保护。严禁任何媒体、网站、个人或组织以任何形式或出于任何目的在未经本实验室书面授权的情況下抄
袭、转载、摘编、修改本网站內容，或链接、转帖或以其他方式复制用于商业目的或发行，或稍作修改后在其它网站上使用，前述行为均将构成对本网站版权之侵
犯，本网站將依法追究其法律责任。<br>
本网站与他人另有协议授权下载的或法律另有规定的，在下载使用时必须注明“稿件来源：浙江大学”。
 </p>
</div>
<span style="clear:both;display:none;"><img src="index_files/wpsf-img.gif" alt="" style="border-style:none;width:0px;height:0px;display:none;" height="0" width="0"></span><div class="yarpp-related">
<h3>Related posts:</h3><ol>
<li><a href="http://www.sel.zju.edu.cn/?p=417" rel="bookmark" title="Kubernetes Minion Node 组件 之 Kubelet">Kubernetes Minion Node 组件 之 Kubelet </a></li>
<li><a href="http://www.sel.zju.edu.cn/?p=595" rel="bookmark" title="kubernetes node components – kubelet">kubernetes node components – kubelet </a></li>
</ol>
</div>
			</div>

	<footer class="entry-meta">
		This entry was posted in <a href="http://www.sel.zju.edu.cn/?cat=16" title="查看Kubernetes中的全部文章" rel="category">Kubernetes</a> and tagged <a href="http://www.sel.zju.edu.cn/?tag=kubernetes" rel="tag">Kubernetes</a> by <a href="http://www.sel.zju.edu.cn/?author=9">chenxingyu</a>. Bookmark the <a href="http://www.sel.zju.edu.cn/?p=484" title="Permalink to Kubernetes代码走读之Minion Node 组件 kube-proxy" rel="bookmark">permalink</a>.		
			</footer>
</article><!-- #post-484 -->

					<div id="comments">
	
	
			
		
		<ol class="commentlist">
				<li class="comment byuser comment-author-chenxingyu bypostauthor even thread-even depth-1" id="li-comment-7">
		<article id="comment-7" class="comment">
			<h2 id="comments-title">
				One thought on “<span>Kubernetes代码走读之Minion Node 组件 kube-proxy</span>”			</h2>
			<footer class="comment-meta">
				<div class="comment-author vcard">
					<img alt="" src="index_files/713c9932dce3723054ca9e06d6bbea68.png" class="avatar avatar-68 photo" height="68" width="68"><span class="fn">chenxingyu</span> on <a href="http://www.sel.zju.edu.cn/?p=484&amp;cpage=1#comment-7"><time datetime="2015-01-22T14:50:35+00:00">2015年1月22日 at 下午2:50</time></a> <span class="says">said:</span>
									</div>

				
			</footer>

			<div class="comment-content"><p>awesome</p>
</div>

			<div class="reply">
				<a class="comment-reply-link" href="http://www.sel.zju.edu.cn/?p=484&amp;replytocom=7#respond" onclick='return addComment.moveForm("comment-7", "7", "respond", "484")'>Reply <span>↓</span></a>			</div>
		</article>

	</li><!-- #comment-## -->
		</ol>

		
		
	
									<div id="respond" class="comment-respond">
				<h3 id="reply-title" class="comment-reply-title">发表评论 <small><a rel="nofollow" id="cancel-comment-reply-link" href="http://www.sel.zju.edu.cn/?p=484#respond" style="display:none;">取消回复</a></small></h3>
									<form action="http://www.sel.zju.edu.cn/wp-comments-post.php" method="post" id="commentform" class="comment-form">
																			<p class="comment-notes">电子邮件地址不会被公开。 必填项已用<span class="required">*</span>标注</p>							<p class="comment-form-author"><label for="author">姓名 <span class="required">*</span></label> <input id="author" name="author" size="30" aria-required="true" type="text"></p>
<p class="comment-form-email"><label for="email">电子邮件 <span class="required">*</span></label> <input id="email" name="email" size="30" aria-required="true" type="text"></p>
<p class="comment-form-url"><label for="url">站点</label> <input id="url" name="url" size="30" type="text"></p>
												<div class="wmd-panel"><div id="wmd-button-barcomment"><ul class="wmd-button-row" id="wmd-button-rowcomment"><li title="Strong &lt;strong&gt; Ctrl+B" id="wmd-bold-buttoncomment" style="left: 0px;" class="wmd-button"><span style="background-position: 0px 0px;"></span></li><li title="Emphasis &lt;em&gt; Ctrl+I" id="wmd-italic-buttoncomment" style="left: 25px;" class="wmd-button"><span style="background-position: -20px 0px;"></span></li><li id="wmd-spacer1comment" class="wmd-spacer wmd-spacer1"></li><li title="Hyperlink &lt;a&gt; Ctrl+L" id="wmd-link-buttoncomment" style="left: 75px;" class="wmd-button"><span style="background-position: -40px 0px;"></span></li><li title="Blockquote &lt;blockquote&gt; Ctrl+Q" id="wmd-quote-buttoncomment" style="left: 100px;" class="wmd-button"><span style="background-position: -60px 0px;"></span></li><li title="Code Sample &lt;pre&gt;&lt;code&gt; Ctrl+K" id="wmd-code-buttoncomment" style="left: 125px;" class="wmd-button"><span style="background-position: -80px 0px;"></span></li><li title="Image &lt;img&gt; Ctrl+G" id="wmd-image-buttoncomment" style="left: 150px;" class="wmd-button"><span style="background-position: -100px 0px;"></span></li><li id="wmd-spacer2comment" class="wmd-spacer wmd-spacer2"></li><li title="Numbered List &lt;ol&gt; Ctrl+O" id="wmd-olist-buttoncomment" style="left: 200px;" class="wmd-button"><span style="background-position: -120px 0px;"></span></li><li title="Bulleted List &lt;ul&gt; Ctrl+U" id="wmd-ulist-buttoncomment" style="left: 225px;" class="wmd-button"><span style="background-position: -140px 0px;"></span></li><li title="Heading &lt;h1&gt;/&lt;h2&gt; Ctrl+H" id="wmd-heading-buttoncomment" style="left: 250px;" class="wmd-button"><span style="background-position: -160px 0px;"></span></li><li title="Horizontal Rule &lt;hr&gt; Ctrl+R" id="wmd-hr-buttoncomment" style="left: 275px;" class="wmd-button"><span style="background-position: -180px 0px;"></span></li><li id="wmd-spacer3comment" class="wmd-spacer wmd-spacer3"></li><li title="Undo - Ctrl+Z" id="wmd-undo-buttoncomment" style="left: 325px;" class="wmd-button"><span style="background-position: -200px -20px;"></span></li><li title="Redo - Ctrl+Y" id="wmd-redo-buttoncomment" style="left: 350px;" class="wmd-button"><span style="background-position: -220px -20px;"></span></li><li title="Markdown Editing Help" style="right: 0px;" id="wmd-help-buttoncomment" class="wmd-button wmd-help-button"><span style="background-position: -240px 0px;"></span></li></ul></div><div style="display: none;" id="wmd-button-bar-help"> <p>To create code blocks or other preformatted text, indent by four spaces:</p>
        <pre class="wmd-help"><span class="wmd-help-spaces">&nbsp;&nbsp;&nbsp;&nbsp;</span>This will be displayed in a monospaced font. The first four 
<span class="wmd-help-spaces">&nbsp;&nbsp;&nbsp;&nbsp;</span>spaces will be stripped off, but all other whitespace
<span class="wmd-help-spaces">&nbsp;&nbsp;&nbsp;&nbsp;</span>will be preserved.
<span class="wmd-help-spaces">&nbsp;&nbsp;&nbsp;&nbsp;</span>
<span class="wmd-help-spaces">&nbsp;&nbsp;&nbsp;&nbsp;</span>Markdown is turned off in code blocks:
<span class="wmd-help-spaces">&nbsp;&nbsp;&nbsp;&nbsp;</span> [This is not a link](http://example.com)
</pre>
        <p>
            To create not a block, but an inline code span, use backticks:
        </p>
        <pre class="wmd-help">Here is some inline `code`.</pre> <p>For more help see <a href="http://daringfireball.net/projects/markdown/syntax" rel="no-follow"> http://daringfireball.net/projects/markdown/syntax</a></p></div><p class="comment-form-comment"><label for="comment">评论</label> <textarea id="comment" name="comment" cols="45" rows="8" aria-required="true"></textarea></p><div id="wmd-previewcomment" class="wmd-panel wmd-preview prettyprint"></div></div>						<p class="form-allowed-tags">您可以使用这些<abbr title="HyperText Markup Language">HTML</abbr>标签和属性： <code>&lt;a
 href="" title=""&gt; &lt;abbr title=""&gt; &lt;acronym title=""&gt; 
&lt;b&gt; &lt;blockquote cite=""&gt; &lt;cite&gt; &lt;code class="" 
title="" data-url=""&gt; &lt;del datetime=""&gt; &lt;em&gt; &lt;i&gt; 
&lt;q cite=""&gt; &lt;strike&gt; &lt;strong&gt; &lt;pre class="" 
title="" data-url=""&gt; &lt;span class="" title="" data-url=""&gt; </code></p>						<p class="form-submit">
							<input name="submit" id="submit" value="发表评论" type="submit">
							<input name="comment_post_ID" value="484" id="comment_post_ID" type="hidden">
<input name="comment_parent" id="comment_parent" value="0" type="hidden">
						</p>
							<script type="text/javascript">
	<!--
	refJS = escape( document[ 'referrer' ] );
	document.write("<input type='hidden' name='refJS' value='"+refJS+"'>");
	// -->
	</script><input name="refJS" value="" type="hidden">
	<p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" value="5b7baade61" type="hidden"></p><p style="display: none;"></p>					<input id="ak_js" name="ak_js" value="1441617528348" type="hidden"></form>
							</div><!-- #respond -->
			
</div>
				
			</div>
		</div>

</div>
	<footer id="colophon" role="contentinfo">
		<div class="wid960 clearfix">
					</div>
		<div id="site-generator">
			<div class="wid960 clearfix">
								<p class="fleft">Powered by <a href="http://www.zju.edu.cn/" target="_blank">Zhejiang University</a></p>
			
				
			</div>
		</div>
	</footer><!-- #colophon -->
</div><!-- #page -->

<a href="http://www.nkuttler.de/wordpress-plugin/a-better-tag-cloud-widget/">Better Tag Cloud</a><br><script type="text/javascript" src="index_files/form.js"></script>
<link rel="stylesheet" id="yarppRelatedCss-css" href="index_files/related.css" type="text/css" media="all">
<link rel="stylesheet" id="wp-markdown-editor-css" href="index_files/markdown-editor.css" type="text/css" media="all">
<script type="text/javascript" src="index_files/markdown-converter.js"></script>
<script type="text/javascript" src="index_files/markdown-sanitizer.js"></script>
<script type="text/javascript" src="index_files/markdown-editor.js"></script>
<script type="text/javascript" src="index_files/markdown.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57516850-1', 'auto');
  ga('send', 'pageview');

</script>

</body></html>